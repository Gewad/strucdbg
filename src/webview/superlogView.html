<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'none'; style-src 'unsafe-inline'; script-src 'unsafe-inline';">
    <style>
        body { 
            font-family: var(--vscode-editor-font-family); 
            padding: 10px; 
            color: var(--vscode-editor-foreground);
            background-color: var(--vscode-editor-background);
        }
        .log-entry { margin-bottom: 5px; border-bottom: 1px solid var(--vscode-panel-border); padding: 4px; }
        .raw { opacity: 0.8; white-space: pre-wrap; }
        .error { color: var(--vscode-errorForeground); }
        
        /* Structured Log Styles */
        .structured { display: flex; flex-direction: column; }
        .header { display: flex; align-items: center; cursor: pointer; }
        .badge { 
            padding: 2px 6px; border-radius: 3px; font-size: 0.8em; margin-right: 10px; font-weight: bold;
            text-transform: uppercase;
        }
        .severity-info { background-color: var(--vscode-progressBar-background); color: white; }
        .severity-debug { background-color: var(--vscode-charts-blue); color: white; }
        .severity-error { background-color: var(--vscode-errorForeground); color: white; }
        .severity-critical { background-color: var(--vscode-errorForeground); color: white; }
        .severity-warn { background-color: var(--vscode-editorWarning-foreground); color: white; }
        
        .details { margin-left: 20px; display: none; background: rgba(128,128,128, 0.1); padding: 5px; }
        .details.open { display: block; }
        .json-key { color: var(--vscode-debugTokenExpression-name); }
        .json-val { color: var(--vscode-debugTokenExpression-string); }

        /* Input Area */
        #input-container {
            position: fixed; bottom: 0; left: 0; right: 0;
            padding: 10px; background: var(--vscode-editor-background);
            border-top: 1px solid var(--vscode-panel-border);
        }
        #repl-input {
            width: 100%; box-sizing: border-box; padding: 8px;
            background: var(--vscode-input-background);
            color: var(--vscode-input-foreground);
            border: 1px solid var(--vscode-input-border);
        }
        #status { 
            position: fixed; top: 5px; right: 5px; 
            padding: 3px 8px; background: var(--vscode-badge-background); 
            color: var(--vscode-badge-foreground); border-radius: 3px; font-size: 0.8em;
        }

        /* Tabs */
        #tabs-container {
            display: flex;
            gap: 5px;
            margin-bottom: 10px;
            border-bottom: 1px solid var(--vscode-panel-border);
            padding-bottom: 5px;
        }
        .tab {
            padding: 5px 12px;
            background: var(--vscode-button-secondaryBackground);
            color: var(--vscode-button-secondaryForeground);
            border: none;
            cursor: pointer;
            border-radius: 3px 3px 0 0;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9em;
        }
        .tab.active {
            background: var(--vscode-button-background);
            color: var(--vscode-button-foreground);
        }
        .tab-close {
            margin-left: 5px;
            opacity: 0.7;
            font-weight: bold;
        }
        .tab-close:hover {
            opacity: 1;
            color: var(--vscode-errorForeground);
        }
        .session-content {
            display: none;
            margin-bottom: 60px;
        }
        .session-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="status">Ready</div>
    <div id="tabs-container"></div>
    <div id="sessions-container"></div>
    <div id="input-container">
        <input id="repl-input" type="text" placeholder="Run command...." />
    </div>

    <script>
        (function() {
            // Initialize immediately
            const status = document.getElementById('status');
            status.textContent = 'Initializing...';
            
            const vscode = acquireVsCodeApi();
            const tabsContainer = document.getElementById('tabs-container');
            const sessionsContainer = document.getElementById('sessions-container');
            const input = document.getElementById('repl-input');
            
            let messageCount = 0;
            let sessionCounter = 0;
            let activeSession = null;
            const sessions = new Map(); // sessionId -> { tab, content, logsDiv, operationGroups }
            
            status.textContent = 'Webview Ready';
            
            // Create initial session
            createSession('Welcome', true);
            const welcomeSession = sessions.get('Welcome');
            const testDiv = document.createElement('div');
            testDiv.className = 'log-entry raw';
            testDiv.textContent = 'Webview script loaded successfully. Start debugging to create a new session.';
            welcomeSession.logsDiv.appendChild(testDiv);

            function createSession(sessionName, isWelcome = false) {
                const sessionId = isWelcome ? sessionName : `session-${++sessionCounter}`;
                
                if (sessions.has(sessionId)) {
                    switchToSession(sessionId);
                    return sessionId;
                }
                
                // Create tab
                const tab = document.createElement('button');
                tab.className = 'tab';
                tab.innerHTML = `<span>${escapeHtml(sessionName)}</span>`;
                
                if (!isWelcome) {
                    const closeBtn = document.createElement('span');
                    closeBtn.className = 'tab-close';
                    closeBtn.textContent = '√ó';
                    closeBtn.onclick = (e) => {
                        e.stopPropagation();
                        closeSession(sessionId);
                    };
                    tab.appendChild(closeBtn);
                }
                
                tab.onclick = () => switchToSession(sessionId);
                tabsContainer.appendChild(tab);
                
                // Create content area
                const content = document.createElement('div');
                content.className = 'session-content';
                content.dataset.sessionId = sessionId;
                
                const logsDiv = document.createElement('div');
                logsDiv.className = 'logs';
                content.appendChild(logsDiv);
                
                sessionsContainer.appendChild(content);
                
                sessions.set(sessionId, {
                    tab,
                    content,
                    logsDiv,
                    operationGroups: new Map(),
                    name: sessionName
                });
                
                switchToSession(sessionId);
                return sessionId;
            }

            function switchToSession(sessionId) {
                if (!sessions.has(sessionId)) return;
                
                // Deactivate all
                sessions.forEach(session => {
                    session.tab.classList.remove('active');
                    session.content.classList.remove('active');
                });
                
                // Activate selected
                const session = sessions.get(sessionId);
                session.tab.classList.add('active');
                session.content.classList.add('active');
                activeSession = sessionId;
            }

            function closeSession(sessionId) {
                if (!sessions.has(sessionId) || sessionId === 'Welcome') return;
                
                const session = sessions.get(sessionId);
                session.tab.remove();
                session.content.remove();
                sessions.delete(sessionId);
                
                // Switch to another session if this was active
                if (activeSession === sessionId) {
                    const remainingSessions = Array.from(sessions.keys());
                    if (remainingSessions.length > 0) {
                        switchToSession(remainingSessions[remainingSessions.length - 1]);
                    }
                }
            }

            // Handle incoming logs from Extension
            window.addEventListener('message', event => {
                const message = event.data;
                
                if (message.type === 'new-session') {
                    // Create new session for debug session
                    createSession(message.sessionName || `Session ${sessionCounter + 1}`);
                } else if (message.type === 'new-log') {
                    messageCount++;
                    status.textContent = 'Messages: ' + messageCount;
                    
                    // Route raw and error logs to Welcome tab
                    let sessionId;
                    if (message.logType === 'raw' || message.logType === 'error') {
                        sessionId = 'Welcome';
                    } else {
                        // For structured logs, use active session or create one
                        sessionId = activeSession;
                        if (!sessionId || sessionId === 'Welcome') {
                            sessionId = createSession(`Session ${sessionCounter + 1}`);
                        }
                    }
                    
                    const session = sessions.get(sessionId);
                    
                    if (message.logType === 'structured' && message.content.operation_id) {
                        // Handle grouped operations
                        handleOperationLog(session, message.content);
                    } else {
                        // Handle standalone logs
                        const div = document.createElement('div');
                        div.className = 'log-entry ' + message.logType;

                        if (message.logType === 'structured') {
                            renderStructured(div, message.content);
                        } else {
                            const prefix = message.logType === 'error' ? 'ERR: ' : 'RAW: ';
                            const content = typeof message.content === 'string' ? message.content : JSON.stringify(message.content);
                            div.textContent = prefix + content;
                        }
                        
                        session.logsDiv.appendChild(div);
                        window.scrollTo(0, document.body.scrollHeight);
                    }
                }
            });

            function handleOperationLog(session, data) {
                const opId = data.operation_id;
                const operationGroups = session.operationGroups;
                
                if (!operationGroups.has(opId)) {
                    // First log for this operation - create the group container
                    const groupDiv = document.createElement('div');
                    groupDiv.className = 'log-entry structured';
                    
                    const subLogsContainer = document.createElement('div');
                    subLogsContainer.className = 'details';
                    subLogsContainer.style.display = 'none';
                    
                    operationGroups.set(opId, {
                        container: groupDiv,
                        subLogs: subLogsContainer,
                        count: 0
                    });
                    
                    renderOperationHeader(groupDiv, data, subLogsContainer);
                    groupDiv.appendChild(subLogsContainer);
                    session.logsDiv.appendChild(groupDiv);
                } else {
                    // Add to existing operation group
                    const group = operationGroups.get(opId);
                    group.count++;
                    
                    // Update header to show count
                    const header = group.container.querySelector('.header');
                    const countBadge = header.querySelector('.op-count') || createCountBadge();
                    if (!header.querySelector('.op-count')) {
                        header.appendChild(countBadge);
                    }
                    countBadge.textContent = `(${group.count + 1} logs)`;
                }
                
                // Add the log as a sub-entry
                const group = operationGroups.get(opId);
                const subLogDiv = document.createElement('div');
                subLogDiv.className = 'log-entry structured';
                subLogDiv.style.marginLeft = '0';
                subLogDiv.style.borderLeft = '3px solid var(--vscode-panel-border)';
                subLogDiv.style.paddingLeft = '8px';
                renderStructured(subLogDiv, data);
                group.subLogs.appendChild(subLogDiv);
                
                window.scrollTo(0, document.body.scrollHeight);
            }

            function createCountBadge() {
                const badge = document.createElement('span');
                badge.className = 'op-count';
                badge.style.marginLeft = '10px';
                badge.style.opacity = '0.7';
                badge.style.fontSize = '0.9em';
                return badge;
            }

            function renderOperationHeader(container, data, subLogsContainer) {
                const header = document.createElement('div');
                header.className = 'header';
                const severity = (data.severity || 'info').toLowerCase();
                
                const emojiMap = {
                    'debug': 'üêõ',
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'warn': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                const emoji = emojiMap[severity] || '‚ÑπÔ∏è';
                
                header.innerHTML = `<span class="badge severity-${severity}">${emoji}</span> <span>${escapeHtml(data.message)}</span> <span style="opacity: 0.6; margin-left: 10px; font-size: 0.85em;">[${escapeHtml(data.operation_id)}]</span>`;
                
                header.addEventListener('click', () => {
                    const isOpen = subLogsContainer.style.display !== 'none';
                    subLogsContainer.style.display = isOpen ? 'none' : 'block';
                });
                
                container.appendChild(header);
            }

            // Handle REPL Input
            input.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    const cmd = input.value;
                    vscode.postMessage({ type: 'evaluate', value: cmd });
                    input.value = '';
                }
            });

            function renderStructured(container, data) {
                const header = document.createElement('div');
                header.className = 'header';
                const severity = (data.severity || 'info').toLowerCase();
                
                // Map severity to emoji
                const emojiMap = {
                    'debug': 'üêõ',
                    'info': '‚ÑπÔ∏è',
                    'warning': '‚ö†Ô∏è',
                    'warn': '‚ö†Ô∏è',
                    'error': '‚ùå',
                    'critical': 'üö®'
                };
                const emoji = emojiMap[severity] || '‚ÑπÔ∏è';
                
                header.innerHTML = `<span class="badge severity-${severity}">${emoji}</span> <span>${escapeHtml(data.message)}</span>`;
                
                const details = document.createElement('div');
                details.className = 'details';
                
                let jsonHtml = '';
                for (const [key, val] of Object.entries(data)) {
                    if (key === 'message' || key === 'severity') continue;
                    jsonHtml += `<div><span class="json-key">${escapeHtml(key)}:</span> <span class="json-val">${escapeHtml(JSON.stringify(val))}</span></div>`;
                }
                details.innerHTML = jsonHtml;

                header.addEventListener('click', () => {
                    details.classList.toggle('open');
                });

                container.appendChild(header);
                container.appendChild(details);
            }
            
            function escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        })();
    </script>
</body>
</html>
